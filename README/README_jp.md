# Ochimamo
このレポジトリはPBLの「おちまも」プロジェクトの一部である。これは、高所作業現場の危険領域を指定するアプリである。

## 1. 概要
`Beacon Grid Editor`は、屋上のフロアプラン画像上に、BLEビーコンなどのデバイスを最適に配置するためのGUIアプリケーションである。
ユーザーは危険区域を指定し、遺伝的アルゴリズム（GA）を用いて、カバレッジが最大になるようなビーコンの配置案を自動で算出できる。
最終的な配置計画は、M5Stackに使用できるようにJSON形式でエクスポートすることが可能である。

## 2. 主な機能
- 画像の読み込み: フロアプランの画像（PNG, JPG）を読み込んでキャンバスに表示する。
- 画像編集:
    - クロップ（切り抜き）: 画像の必要な部分だけを切り抜いて使用できる。
    - 危険区域の設定: ビーコンを設置したくないエリアを矩形で複数指定できる
- グリッド設定: 画像の縮尺を実際の寸法（メートル）に合わせて設定し、仮想的な設置候補グリッドを生成する。
- ビーコンの最適配置: 遺伝的アルゴリズム（GA）を利用して、危険区域を避けながら、カバレッジを最大化するビーコンの配置を計算する。
- 設定のエクスポート: 算出されたビーコンの座標、グリッド情報、寸法などをJSONファイルとして保存できる。

## 3. 必要なライブラリ
本アプリケーションを実行するには、以下のPythonライブラリが必要である。
- `customtkinter`
- `Pillow`
- `opencv-python`
- `numpy`

## 4. インストール方法
以下のコマンドを実行して、必要なライブラリをインストールする。
``` bash
pip install customtkinter Pillow opencv-python numpy
```

## 5. 使用方法
1. リポジトリをクローンまたはダウンロードし、ターミナルでプロジェクトのディレクトリに移動する。
2. 以下のコマンドでアプリケーションを起動する。
``` bash
python main.py
```
3. 基本的な操作フロー:
    1. Open Image: フロアプランの画像ファイルを開く。
    2. Set Grid: Grid W (m) と Grid H (m) に画像の実際の幅と高さをメートル単位で入力し、Set Gridボタンを押す。
    3. Toggle Danger Zone: 危険区域（ビーコンを置きたくない場所）を指定するための赤い矩形を表示する。矩形はドラッグして移動・リサイズできる。
    4. Apply Danger Zone: 矩形の場所を危険区域としてマスクに適用する。この操作は複数回繰り返すことができる。
    5. Run Estimation: 全ての設定が完了したら、このボタンを押して遺伝的アルゴリズムによる最適配置計算を実行する。計算が完了すると、青い円でビーコンの配置場所が示される
    6. Export JSON: 最終的な配置情報をJSONファイルとして保存する。

## 6. ファイル構成
本プロジェクトは、Model-View-Controller (MVC) の考え方に基づいて、以下のファイルに分割されている。
- `main.py`: アプリケーション全体を起動するメインファイルである。各コンポーネント（Model, View, Controller）を初期化し、ウィンドウを構築する。
- `AppState.py`: Model: アプリケーションの状態（読み込んだ画像、ズームレベル、各種座標など）を一元管理する。
- `Controller.py`: Controller: アプリケーションのコアロジックを担う。ボタンが押された際の処理や、アルゴリズムの実行などを行う。
- `ControlPanel.py`: View: ウィンドウ右側の操作パネルのUIを構築する。
- `Canvas.py`: View: 画像を表示し、マウス操作（ズーム、ドラッグなど）を受け付けるメインキャンバスのUIを構築する。
- `ImageProcessor.py`: 画像処理に関するヘルパー関数（危険区域の自動検出、建物のマスク作成など）をまとめたクラスである。
- `Genetic.py`: ビーコンの最適配置を計算するための遺伝的アルゴリズムを実装したクラスである。